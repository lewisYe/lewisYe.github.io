<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Webpack | FE Knowledge</title>
    <meta name="description" content="前端知识点梳理">
    
    
    <link rel="preload" href="/assets/css/0.styles.b194f207.css" as="style"><link rel="preload" href="/assets/js/app.94b2f3ef.js" as="script"><link rel="preload" href="/assets/js/2.d467c8ee.js" as="script"><link rel="preload" href="/assets/js/10.7358a0a7.js" as="script"><link rel="prefetch" href="/assets/js/11.b76e3d06.js"><link rel="prefetch" href="/assets/js/12.a146812a.js"><link rel="prefetch" href="/assets/js/13.cf5c1852.js"><link rel="prefetch" href="/assets/js/14.c5690a9e.js"><link rel="prefetch" href="/assets/js/15.cfd708ec.js"><link rel="prefetch" href="/assets/js/16.667fb96d.js"><link rel="prefetch" href="/assets/js/17.09141bb2.js"><link rel="prefetch" href="/assets/js/18.65cc8cb4.js"><link rel="prefetch" href="/assets/js/19.742f92d8.js"><link rel="prefetch" href="/assets/js/20.93f5ef9b.js"><link rel="prefetch" href="/assets/js/21.bf458488.js"><link rel="prefetch" href="/assets/js/3.64e9b869.js"><link rel="prefetch" href="/assets/js/4.e7adceac.js"><link rel="prefetch" href="/assets/js/5.d198a837.js"><link rel="prefetch" href="/assets/js/6.eee8a3aa.js"><link rel="prefetch" href="/assets/js/7.4250d63b.js"><link rel="prefetch" href="/assets/js/8.c395ce89.js"><link rel="prefetch" href="/assets/js/9.10bd2809.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b194f207.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">FE Knowledge</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/lewisYe" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/lewisYe" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/introduction.html" class="sidebar-link">介绍</a></li><li><a href="/html.html" class="sidebar-link">HTML</a></li><li><a href="/css.html" class="sidebar-link">CSS</a></li><li><a href="/js_base.html" class="sidebar-link">JS 基础</a></li><li><a href="/js_advanced.html" class="sidebar-link">手写JS</a></li><li><a href="/es6.html" class="sidebar-link">ES6</a></li><li><a href="/browser.html" class="sidebar-link">浏览器系列</a></li><li><a href="/network.html" class="sidebar-link">网络</a></li><li><a href="/react.html" class="sidebar-link">React</a></li><li><a href="/webpack.html" class="active sidebar-link">Webpack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webpack.html#基础配置" class="sidebar-link">基础配置</a></li><li class="sidebar-sub-header"><a href="/webpack.html#性能优化" class="sidebar-link">性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webpack.html#分析工具" class="sidebar-link">分析工具</a></li><li class="sidebar-sub-header"><a href="/webpack.html#优化方案" class="sidebar-link">优化方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/webpack.html#writing-a-loader" class="sidebar-link">Writing a Loader</a></li><li class="sidebar-sub-header"><a href="/webpack.html#writing-a-plugin" class="sidebar-link">Writing a Plugin</a></li><li class="sidebar-sub-header"><a href="/webpack.html#webpack核心原理" class="sidebar-link">webpack核心原理</a></li><li class="sidebar-sub-header"><a href="/webpack.html#webpack-热更新原理" class="sidebar-link">webpack 热更新原理</a></li><li class="sidebar-sub-header"><a href="/webpack.html#ast" class="sidebar-link">AST</a></li><li class="sidebar-sub-header"><a href="/webpack.html#webpack5" class="sidebar-link">webpack5</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/webpack.html#功能清除" class="sidebar-link">功能清除</a></li><li class="sidebar-sub-header"><a href="/webpack.html#针对长期缓存的优化" class="sidebar-link">针对长期缓存的优化</a></li><li class="sidebar-sub-header"><a href="/webpack.html#构建优化" class="sidebar-link">构建优化</a></li><li class="sidebar-sub-header"><a href="/webpack.html#重大变更：长期未解决的问题" class="sidebar-link">重大变更：长期未解决的问题</a></li><li class="sidebar-sub-header"><a href="/webpack.html#主要的内部架构变更" class="sidebar-link">主要的内部架构变更</a></li></ul></li><li class="sidebar-sub-header"><a href="/webpack.html#babel" class="sidebar-link">babel</a></li></ul></li><li><a href="/ts.html" class="sidebar-link">TypeScript</a></li><li><a href="/performance.html" class="sidebar-link">性能</a></li><li><a href="/algorithm.html" class="sidebar-link">数据结构与算法</a></li><li><a href="/design.html" class="sidebar-link">设计模式</a></li><li><a href="/other.html" class="sidebar-link">其它</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="webpack"><a href="#webpack" aria-hidden="true" class="header-anchor">#</a> Webpack</h1> <h2 id="基础配置"><a href="#基础配置" aria-hidden="true" class="header-anchor">#</a> 基础配置</h2> <p>本文就不过多的说明基础配置, 具体配置可查看<a href="https://github.com/lewisYe/react-cli" target="_blank" rel="noopener noreferrer">本链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="性能优化"><a href="#性能优化" aria-hidden="true" class="header-anchor">#</a> 性能优化</h2> <h3 id="分析工具"><a href="#分析工具" aria-hidden="true" class="header-anchor">#</a> 分析工具</h3> <p>在进行性能优化之前，是不是需要知道哪里需要被优化，所以我们需要分析工具。</p> <h4 id="速度分析"><a href="#速度分析" aria-hidden="true" class="header-anchor">#</a> 速度分析</h4> <p>使用 <code>speed-measure-webpack-plugin</code> 插件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// 安装</span>

npm i speed<span class="token operator">-</span>measure<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">// webpack.config.js配置</span>
<span class="token keyword">const</span> SpeedMeasureWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'speed-measure-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> swp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeedMeasureWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

swp<span class="token punctuation">.</span><span class="token function">warp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// webpack配置</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>使用warp方法将webpack配置包裹 <a href="https://www.npmjs.com/package/speed-measure-webpack-plugin" target="_blank" rel="noopener noreferrer">具体配置查看<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>效果如下图：
<img src="/assets/img/smp.04a8c0b8.png" alt=""></p> <p>该插件主要的工作是：计算整个打包总消耗；具体loader和plugin所花费的具体时间</p> <h4 id="体积分析"><a href="#体积分析" aria-hidden="true" class="header-anchor">#</a> 体积分析</h4> <p>打包后的体积优化是一个可以着重优化的点，比如引入的一些第三方组件库过大，这时就要考虑是否需要寻找替代品了。例如moment</p> <p>使用 <code>webpack-bundle-analyzer</code> 插件来分析包体积大小</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// 安装 </span>
npm i webpack<span class="token operator">-</span>bundle<span class="token operator">-</span>analyzer <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">//webpack.config.js</span>
<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-bundle-analyzer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a href="https://www.npmjs.com/package/webpack-bundle-analyzer" target="_blank" rel="noopener noreferrer">具体配置查看<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>然后在命令行工具中输入npm run build，它默认会起一个端口号为 8888 的本地服务器：</p> <p><img src="/assets/img/analyzer.b9fe9054.jpg" alt=""></p> <h3 id="优化方案"><a href="#优化方案" aria-hidden="true" class="header-anchor">#</a> 优化方案</h3> <ul><li>使用高版本的webpack 和 node.js</li> <li>多进程/多实例构建
<ul><li>thread-loader</li> <li>happypack</li> <li>parallel-webpack</li></ul></li> <li>多进程并行压缩
<ul><li>terser-webpack-plugin</li> <li>uglifyjs-webpack-plugin</li> <li>parallel-uglify-plugin</li></ul></li> <li>分包 与 预编译
<ul><li>webpack externals</li></ul></li> <li>开启缓存
<ul><li>babel-loader 开始缓存</li> <li>terser-webpack-plugin 开启缓存 cache  true</li> <li>cache-loader 和 hard-source-webpack-plugin</li></ul></li> <li>缩小构建目标
<ul><li>babel-loader 的时候 不解析node_modules里面的内容 使用exclude,和include的使用</li> <li>优化 resolve.modules 配置 缩小搜索范围层级</li> <li>优化 resolve.mainFields 配置 查询入口文件</li> <li>优化 resolve.extensions 后缀名</li> <li>合理使用 resolve.alias</li></ul></li> <li>tree shaking</li> <li>图片压缩</li> <li>polyfill service优化构建体积</li> <li>socpe hoisting</li></ul> <h4 id="使用高版本的webpack-和-node-js"><a href="#使用高版本的webpack-和-node-js" aria-hidden="true" class="header-anchor">#</a> 使用高版本的webpack 和 node.js</h4> <p>比如webpack4 的打包速度就快于webpack3；node 的版本更高速度也会更快</p> <p>webpack 优化原因</p> <p>V8 带来的优化 使用for of 代替了forEach 、Map和Set代替了Object 、includes代替了indexOf</p> <p>默认使用更快的md4 hash算法</p> <p>webpacks AST可以直接从loader传递给 AST 减少传递时间</p> <p>使用字符串代替正则表达式</p> <h4 id="多进程-多实例构建"><a href="#多进程-多实例构建" aria-hidden="true" class="header-anchor">#</a> 多进程/多实例构建</h4> <p>可以使用的插件有</p> <ul><li>thread-loader</li> <li>happypack</li> <li>parallel-webpack</li></ul> <p><strong>thread-loader 用法</strong></p> <p>thread-loader 会将你的 loader 放置在一个 worker 池里面运行，以达到多线程构建。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 安装</span>
npm i thread<span class="token operator">-</span>loader <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">//webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            test<span class="token punctuation">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
            include<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;src&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            use<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    loader<span class="token punctuation">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
                    options<span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    workers<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>把这个 loader 放置在其他 loader 之前（如下面示例的位置）， 放置在这个 loader 之后的 loader 就会在一个单独的 worker 池(worker pool)中运行。</p> <p><a href="https://www.npmjs.com/package/thread-loader" target="_blank" rel="noopener noreferrer">更多配置查看<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>HappyPack 用法</strong></p> <p>HappyPack 可以让 Webpack 同一时间处理多个任务，发挥多核 CPU 的能力，将任务分解给多个子进程去并发的执行，子进程处理完后，再把结果发送给主进程。通过多进程模型，来加速代码构建。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 安装</span>

npm i happypack <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> HappyPack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'happypack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>module <span class="token operator">=</span> <span class="token punctuation">{</span>
    rules<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token regex">/.js$/</span><span class="token punctuation">,</span>
        use<span class="token punctuation">:</span> <span class="token string">'happypack/loader'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HappyPack</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        loaders<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>该方法在webpack3中使用比较多，而且目前作者都不在维护该库，并推荐在webpack 4中使用 <code>thread-loader</code> 更多happypack配置查看<a href="https://www.npmjs.com/package/happypack" target="_blank" rel="noopener noreferrer">配置连接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><code>thread-loader</code> 和 <code>happypack</code> 对于小型项目来说打包速度几乎没有影响，甚至可能会增加开销，所以建议尽量在大项目中采用。</p> <h4 id="多进程并行压缩"><a href="#多进程并行压缩" aria-hidden="true" class="header-anchor">#</a> 多进程并行压缩</h4> <p>webpack默认提供了UglifyJS插件来压缩JS代码，但是它使用的是单线程压缩代码，也就是说多个js文件需要被压缩，它需要一个个文件进行压缩。所以说在正式环境打包压缩代码速度非常慢(因为压缩JS代码需要先把代码解析成用Object抽象表示的AST语法树，再应用各种规则分析和处理AST，导致这个过程耗时非常大)。</p> <p>所以我们要对压缩代码这一步骤进行优化，常用的做法就是多进程并行压缩</p> <p>目前有三种主流的压缩方案：</p> <ul><li>terser-webpack-plugin</li> <li>uglifyjs-webpack-plugin</li> <li>parallel-uglify-plugin</li></ul> <h4 id="terser-webpack-plugin"><a href="#terser-webpack-plugin" aria-hidden="true" class="header-anchor">#</a> terser-webpack-plugin</h4> <p>不知道你有没有发现：webpack4 已经默认支持 ES6语法的压缩。而这离不开terser-webpack-plugin。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 安装</span>
npm i terser<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">//webpack.config.js</span>

<span class="token keyword">const</span> TerserPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  optimization<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    minimize<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    minimizer<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        parallel<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="uglifyjs-webpack-plugin"><a href="#uglifyjs-webpack-plugin" aria-hidden="true" class="header-anchor">#</a> uglifyjs-webpack-plugin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 安装 </span>
npm i uglifyjs<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">//webpack.config.js</span>
<span class="token keyword">const</span> UglifyJsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'uglifyjs-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      uglifyOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        warnings<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        parse<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        compress<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        ie8<span class="token punctuation">:</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      parallel<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>通过设置parallel: true开启多进程压缩。</p> <h4 id="parallel-uglify-plugin"><a href="#parallel-uglify-plugin" aria-hidden="true" class="header-anchor">#</a> parallel-uglify-plugin</h4> <p>当webpack有多个JS文件需要输出和压缩时，原来会使用UglifyJS去一个个压缩并且输出，而ParallelUglifyPlugin插件则会开启多个子进程，把对多个文件压缩的工作分给多个子进程去完成，但是每个子进程还是通过UglifyJS去压缩代码。并行压缩可以显著的提升效率。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 安装</span>
npm i webpack<span class="token operator">-</span>parallel<span class="token operator">-</span>uglify<span class="token operator">-</span>plugin <span class="token operator">-</span><span class="token constant">D</span>

<span class="token comment">//webpack.comfig.jss</span>

<span class="token keyword">import</span> ParallelUglifyPlugin <span class="token keyword">from</span> <span class="token string">'webpack-parallel-uglify-plugin'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">ParallelUglifyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// Optional regex, or array of regex to match file against. Only matching files get minified.</span>
      <span class="token comment">// Defaults to /.js$/, any file ending in .js.</span>
      test<span class="token punctuation">,</span>
      include<span class="token punctuation">,</span> <span class="token comment">// Optional regex, or array of regex to include in minification. Only matching files get minified.</span>
      exclude<span class="token punctuation">,</span> <span class="token comment">// Optional regex, or array of regex to exclude from minification. Matching files are not minified.</span>
      cacheDir<span class="token punctuation">,</span> <span class="token comment">// Optional absolute path to use as a cache. If not provided, caching will not be used.</span>
      workerCount<span class="token punctuation">,</span> <span class="token comment">// Optional int. Number of workers to run uglify. Defaults to num of cpus - 1 or asset count (whichever is smaller)</span>
      sourceMap<span class="token punctuation">,</span> <span class="token comment">// Optional Boolean. This slows down the compilation. Defaults to false.</span>
      uglifyJS<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// These pass straight through to uglify-js@3.</span>
        <span class="token comment">// Cannot be used with uglifyES.</span>
        <span class="token comment">// Defaults to {} if not neither uglifyJS or uglifyES are provided.</span>
        <span class="token comment">// You should use this option if you need to ensure es5 support. uglify-js will produce an error message</span>
        <span class="token comment">// if it comes across any es6 code that it can't parse.</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      uglifyES<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// These pass straight through to uglify-es.</span>
        <span class="token comment">// Cannot be used with uglifyJS.</span>
        <span class="token comment">// uglify-es is a version of uglify that understands newer es6 syntax. You should use this option if the</span>
        <span class="token comment">// files that you're minifying do not need to run in older browsers/versions of node.</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>注意：webpack-parallel-uglify-plugin已不再维护，这里不推荐使用</p> <h4 id="分包-与-预编译"><a href="#分包-与-预编译" aria-hidden="true" class="header-anchor">#</a> 分包 与 预编译</h4> <p>什么是预编译</p> <p>在使用webpack进行打包时候，对于依赖的第三方库，比如React，Redux等这些不会修改的依赖，我们可以让它和我们自己编写的代码分开打包，这样做的好处是每次更改我本地代码的文件的时候，webpack只需要打包我项目本身的文件代码，而不会再去编译第三方库。</p> <p>那么第三方库在第一次打包的时候只打包一次，以后只要我们不升级第三方包的时候，那么webpack就不会对这些库去打包，这样的可以快速的提高打包的速度。其实也就是预编译资源模块。</p> <p>webpack中，我们可以结合DllPlugin 和 DllReferencePlugin插件来实现。</p> <p>但是发现在 vue-cli 和 create-react-app 抛弃了 该种方法 也可以使用hard-source-webpack-plugin 来代替 所以该方法作为了解吧。有兴趣的同学可以深入了解一下。</p> <h4 id="开启缓存"><a href="#开启缓存" aria-hidden="true" class="header-anchor">#</a> 开启缓存</h4> <ul><li>babel-loader 开始缓存</li> <li>terser-webpack-plugin 开启缓存</li> <li>cache-loader 和 hard-source-webpack-plugin</li></ul> <p>缓存对于首次构建时间没有太大变化，但是第二次构建有显著提升</p> <h4 id="缩小构建目标"><a href="#缩小构建目标" aria-hidden="true" class="header-anchor">#</a> 缩小构建目标</h4> <ul><li>babel-loader 的时候 不解析node_modules里面的内容 使用exclude,和include的使用</li> <li>优化 resolve.modules 配置 缩小搜索范围层级</li> <li>优化 resolve.mainFields 配置 查询入口文件</li> <li>优化 resolve.extensions 后缀名</li> <li>合理使用 resolve.alias</li></ul> <h4 id="tree-shaking"><a href="#tree-shaking" aria-hidden="true" class="header-anchor">#</a> tree shaking</h4> <ul><li>purgecss-webpack-plugin 去除无效css</li></ul> <h4 id="图片压缩"><a href="#图片压缩" aria-hidden="true" class="header-anchor">#</a> 图片压缩</h4> <ul><li>image-webpack-loader</li></ul> <h4 id="polyfill-service优化构建体积"><a href="#polyfill-service优化构建体积" aria-hidden="true" class="header-anchor">#</a> polyfill service优化构建体积</h4> <p>es6语法不兼容 需要使用到polyfill去转换</p> <table><thead><tr><th style="text-align:center;">方案</th> <th style="text-align:center;">优点</th> <th style="text-align:center;">缺点</th> <th style="text-align:center;">推荐</th></tr></thead> <tbody><tr><td style="text-align:center;">babel-polyfill</td> <td style="text-align:center;">react推荐</td> <td style="text-align:center;">1.包体积200k+，难以单独抽离Map、Set</td> <td style="text-align:center;">❎</td></tr> <tr><td style="text-align:center;">babel-plugin-transform-runtime</td> <td style="text-align:center;">能只polyfill用到的类和方法，相对体积小</td> <td style="text-align:center;">不能polyfill原型上的方法，不能应用于复杂的业务场景</td> <td style="text-align:center;">❎</td></tr> <tr><td style="text-align:center;">自己写一个库</td> <td style="text-align:center;">定制化、体积小</td> <td style="text-align:center;">重复造轮子、需要更新维护</td> <td style="text-align:center;">❎</td></tr> <tr><td style="text-align:center;">polyfill-service</td> <td style="text-align:center;">只给用户返回用到的polyfill、社区维护</td> <td style="text-align:center;">国内奇葩浏览器UA不能识别、但可以降级处理返回全部的polyfill</td> <td style="text-align:center;">✅</td></tr></tbody></table> <p>https://polyfill.io/v3/ 官网</p> <h4 id="socpe-hoisting"><a href="#socpe-hoisting" aria-hidden="true" class="header-anchor">#</a> socpe hoisting</h4> <p>Scope hoisting 直译过来就是「作用域提升」。熟悉 JavaScript 都应该知道「函数提升」和「变量提升」，JavaScript 会把函数和变量声明提升到当前作用域的顶部。「作用域提升」也类似于此，webpack 会把引入的 js 文件“提升到”它的引入者顶部。</p> <p>Scope Hoisting 可以让 Webpack 打包出来的代码文件更小、运行的更快。</p> <p>要在 Webpack 中使用 Scope Hoisting 非常简单，因为这是 Webpack 内置的功能，只需要配置一个插件，相关代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>optimize<span class="token punctuation">.</span>ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>该插件在webpack4中是默认开启的。</p> <p><strong>对比使用效果</strong></p> <p>现在有个文件分别是：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// constant.js</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token string">'Hello,Jack-cool'</span><span class="token punctuation">;</span>


<span class="token comment">// 入口文件 main.js</span>
<span class="token keyword">import</span> str <span class="token keyword">from</span> <span class="token string">'./constant.js'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>未启用Scope Hoisting打包之后</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">[</span>
  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> __WEBPACK_IMPORTED_MODULE_0__constant_js__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>__WEBPACK_IMPORTED_MODULE_0__constant_js__<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    __webpack_exports__<span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Hello,Jack-cool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
</code></pre></div><p>在开启 Scope Hoisting 后</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">[</span>
  <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> constant <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Hello,Jack-cool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>constant<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

</code></pre></div><p>从中可以看出开启 Scope Hoisting 后，函数申明由两个变成了一个，constant.js 中定义的内容被直接注入到了 main.js 对应的模块中。</p> <p>这样做的好处是：</p> <ul><li>代码体积更小，因为函数申明语句会产生大量代码；</li> <li>代码在运行时因为创建的函数作用域更少了，内存开销也随之变小。</li></ul> <p>Scope Hoisting 的实现原理其实很简单：分析出模块之间的依赖关系，尽可能的把打散的模块合并到一个函数中去，但前提是不能造成代码冗余。因此只有那些被引用了一次的模块才能被合并。</p> <p>注意： 由于 Scope Hoisting 需要分析出模块之间的依赖关系，因此源码必须采用 ES6 模块化语句，不然它将无法生效。</p> <h2 id="writing-a-loader"><a href="#writing-a-loader" aria-hidden="true" class="header-anchor">#</a> Writing a Loader</h2> <p><a href="https://webpack.js.org/contribute/writing-a-loader/" target="_blank" rel="noopener noreferrer">文档链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>开发插件中一般会用到的工具库 <code>loader-utils</code> 和 <code>schema-utils</code></p> <p><code>loader-utils</code> 有很多工具类方法 <a href="https://github.com/webpack/loader-utils" target="_blank" rel="noopener noreferrer">具体配置项链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><code>schema-utils</code>用于参数校验</p> <p>可以直接return 单个结果  多个结果可以使用<code>this.callback(err, values...)</code></p> <p>比如实现一个中文转unicode</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">unicodeLoader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/([\u0080-\uffff])/g</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hex <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> hex<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hex <span class="token operator">=</span> <span class="token template-string"><span class="token string">`0</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`\\u</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="writing-a-plugin"><a href="#writing-a-plugin" aria-hidden="true" class="header-anchor">#</a> Writing a Plugin</h2> <p>开发一个插件 必须是一个类，类中必须有一个apply 方法。 apply方法会有一个<code>compiler</code>参数。</p> <p>然后通过监听hooks 进行操作 比如监听emit hook</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code> compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'MyPlugin'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
     <span class="token comment">// 插件功能</span>
 <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><a href="https://webpack.js.org/contribute/writing-a-plugin/" target="_blank" rel="noopener noreferrer">文档链接<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="webpack核心原理"><a href="#webpack核心原理" aria-hidden="true" class="header-anchor">#</a> webpack核心原理</h2> <p>webpack本质上是一种事件流的机制，它的工作流程就是将各个插件串联起来，而实现这一切的核心就是Tapable，webpack中最核心的负责编译的Compiler和负责创建bundles的Compilation都是Tapable的实例。</p> <p>Tapable 提供了很多钩子函数 包含sync 和 async 的 供编写插件使用 有点事件监听的感觉</p> <p>Webpack 的运行流程是一个串行的过程,从启动到结束会依次执行以下流程 :</p> <ol><li>初始化参数：从配置文件和 Shell 语句中读取与合并参数,得出最终的参数。</li> <li>开始编译：用上一步得到的参数初始化 Compiler 对象,加载所有配置的插件,执行对象的 run 方法开始执行编译。
webpack的编译都按照下面的钩子调用顺序执行。</li></ol> <ul><li>before-run 清除缓存</li> <li>run 注册缓存数据钩子</li> <li>before-compile</li> <li>compile 开始编译</li> <li>make 从入口分析依赖以及间接依赖模块，创建模块对象</li> <li>build-module 模块构建</li> <li>seal 构建结果封装， 不可再更改</li> <li>after-compile 完成构建，缓存数据</li> <li>emit 输出到dist目录</li></ul> <ol start="3"><li>确定入口：根据配置中的 entry 找出所有的入口文件。
在webpack make钩子中, tapAsync注册了一个DllEntryPlugin, 就是将入口模块通过调用compilation.addEntry方法将所有的入口模块添加到编译构建队列中，开启编译流程。在addEntry 中调用_addModuleChain开始编译。在_addModuleChain首先会生成模块，最后构建。
_addModuleChain调用buildModule方法进行编译代码，build中 其实是利用acorn编译生成AST 设计loader的加载使用
在编译完成后，调用compilation.seal方法封闭，生成资源，这些资源保存在compilation.assets, compilation.chunk</li> <li>编译模块：从入口文件出发,调用所有配置的 Loader 对模块进行翻译,再找出该模块依赖的模块,再递归本步骤直到所有入口依赖的文件都经过了本步骤的处理。</li> <li>完成模块编译：在经过第 4 步使用 Loader 翻译完所有模块后,得到了每个模块被翻译后的最终内容以及它们之间的依赖关系。</li> <li>输出资源：根据入口和模块之间的依赖关系,组装成一个个包含多个模块的 Chunk,再把每个 Chunk 转换成一个单独的文件加入到输出列表,这步是可以修改输出内容的最后机会。</li> <li>输出完成：在确定好输出内容后,根据配置确定输出的路径和文件名,把文件内容写入到文件系统。</li></ol> <h2 id="webpack-热更新原理"><a href="#webpack-热更新原理" aria-hidden="true" class="header-anchor">#</a> webpack 热更新原理</h2> <h2 id="ast"><a href="#ast" aria-hidden="true" class="header-anchor">#</a> AST</h2> <h2 id="webpack5"><a href="#webpack5" aria-hidden="true" class="header-anchor">#</a> webpack5</h2> <p>2020年10月10号webpack5发布了，带了许多的变更。下面就聊一聊我所认识的对我有影响的点。（其实我就是看懂了哪些，哈哈哈哈）</p> <p>本次重大发布的整体发展方向如下：</p> <ul><li>尝试用持久性缓存来提高构建性能。</li> <li>尝试用更好的算法和默认值来改进长期缓存。</li> <li>尝试用更好的 Tree Shaking 和代码生成来改善包大小。</li> <li>尝试改善与网络平台的兼容性。</li> <li>尝试在不引入任何破坏性变化的情况下，清理那些在实现 v4 功能时处于奇怪状态的内部结构。</li> <li>试图通过现在引入突破性的变化来为未来的功能做准备，尽可能长时间地保持在 v5 版本上。</li></ul> <h3 id="功能清除"><a href="#功能清除" aria-hidden="true" class="header-anchor">#</a> 功能清除</h3> <ol><li>清理已经废弃的功能</li></ol> <p>所有在webpack4标记即将过期的功能，都在该版本移除。所以再升级之前请确认没有废弃的功能点。</p> <ol start="2"><li>不再为Node.js模块自动引用Polyfills</li></ol> <p>在webpack4及之前的版本，项目中有使用node.js内置模块会自动添加Polyfills；在webpack5中将不会再添加。如果你的项目中有需要用到请手动添加。</p> <h3 id="针对长期缓存的优化"><a href="#针对长期缓存的优化" aria-hidden="true" class="header-anchor">#</a> 针对长期缓存的优化</h3> <ol><li>确定的Chunk、模块ID和导出名称</li></ol> <p>新增了长期的缓存的算法。这些算法在生产环境是默认开启的。</p> <p><code>chunkIds:&quot;deterministic&quot;</code> <code>moduleIds:&quot;deterministic&quot;</code> <code>mangleExports:&quot;deterministic&quot;</code></p> <p>该算法以确定性的方式为模块和分块分配短的（3 或 5 位）数字 ID，这是包大小和长期缓存之间的一种权衡。由于这些配置将使用确定的 ID 和名称，这意味着生成的缓存失效不再更频繁。</p> <ol start="2"><li>真正的contenthash</li></ol> <p>在webpack5中将使用真正的文件内容哈希。之前的版本它&quot;只&quot;使用内容结构的哈希值。当只有注释被修改或者变量被重命名，这对长期缓存会有积极影响。这些变化在压缩后是不可见的。</p> <h3 id="构建优化"><a href="#构建优化" aria-hidden="true" class="header-anchor">#</a> 构建优化</h3> <ol><li>嵌套的tree-shaking</li></ol> <p>webpack现在能够跟着对导出的嵌套属性的访问。这可以改善重新导出命名空间 对象时的 Tree Shaking（清除未使用的导出和混淆导出）。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// inner.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">// module.js</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">as</span> inner <span class="token keyword">from</span> <span class="token string">'./inner'</span><span class="token punctuation">;</span>
<span class="token comment">// 或 import * as inner from './inner'; export { inner };</span>

<span class="token comment">// user.js</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> module <span class="token keyword">from</span> <span class="token string">'./module'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在这个例子中，可以在生产模式下删除导出的b。</p> <ol start="2"><li>内部模块tree-shaking</li></ol> <p>webpack4没有分析模块的导出和引用之间的依赖关系。webpack5中有一个新的选项<code>optimization.innerGrph</code>，在生产模式下是默认开启的，它可以对模块中的标志进行分析，找出导出和引用之间的依赖关系。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> something <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./something'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">usingSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> something<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">usingSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>内部依赖图算法会找出 something 只有在使用 test 导出时才会使用。这允许将更多的出口标记为未使用，并从代码包中省略更多的代码。</p> <p>当设置<code>&quot;sideEffects&quot;: false</code>时，可以省略更多的模块。在这个例子中，当 <code>test</code> 导出未被使用时，<code>./something</code> 将被省略。</p> <ol start="3"><li>commonJs tree-shaking</li></ol> <p>webpack 曾经不进行对 CommonJs 导出和 require() 调用时的导出使用分析。</p> <p>webpack 5 增加了对一些 CommonJs 构造的支持，允许消除未使用的 CommonJs 导出，并从 require() 调用中跟踪引用的导出名称。</p> <h3 id="重大变更：长期未解决的问题"><a href="#重大变更：长期未解决的问题" aria-hidden="true" class="header-anchor">#</a> 重大变更：长期未解决的问题</h3> <ol><li>单一文件目标的代码分割</li></ol> <p>只允许启动单个文件的目标（如 node、WebWorker、electron main）现在支持运行时自动加载引导所需的依赖代码片段。</p> <p>这允许对这些目标使用 chunks: &quot;all&quot; 和 optimization.runtimeChunk。</p> <ol start="2"><li>更新了解析器</li></ol> <p><code>enhanced-resolve</code>更新到了v5版本，有以下改进：</p> <ul><li>追踪更多的依赖关系，比如丢失的文件</li> <li>别名可能有多种选择</li> <li>现在可以别名为<code>false</code>了</li> <li>支持 exports 和 imports 字段等功能</li> <li>性能提高</li></ul> <ol start="3"><li>没有JS的代码块</li></ol> <p>不包含 JS 代码的块，将不再生成 JS 文件。这就允许有只包含 CSS 的代码块。</p> <h3 id="主要的内部架构变更"><a href="#主要的内部架构变更" aria-hidden="true" class="header-anchor">#</a> 主要的内部架构变更</h3> <ol><li>新的插件运行顺序</li></ol> <p>现在 webpack 5 中的插件在应用配置默认值之前就会被应用。这使得插件可以应用自己的默认值，或者作为配置预设。但这也是一个突破性的变化，因为插件在应用时不能依赖配置值的设置。</p> <p>参考链接：<a href="https://mp.weixin.qq.com/s/sh7rcv6hdhYfWr1bv_ssbg" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s/sh7rcv6hdhYfWr1bv_ssbg<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ol start="2"><li>入口文件的新增配置</li></ol> <p>webpack 5 中，入口文件除了字符串、字符串数组，也可以使用描述符进行配置了，如：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
 entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
   catalog<span class="token punctuation">:</span> <span class="token punctuation">{</span>
     <span class="token keyword">import</span><span class="token punctuation">:</span> <span class="token string">'./catalog.js'</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>此外，也可以定义输出的文件名，之前都是通过 output.filename 进行定义的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    about<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">import</span><span class="token punctuation">:</span> <span class="token string">'./about.js'</span><span class="token punctuation">,</span> filename<span class="token punctuation">:</span> <span class="token string">'pages/[name][ext]'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>Tapable 插件升级</li></ol> <p>webpack 3 插件的 compat 层已经被移除。它在 webpack 4 中已经被取消了。一些较少使用的 tapable API 被删除或废弃。</p> <h2 id="babel"><a href="#babel" aria-hidden="true" class="header-anchor">#</a> babel</h2> <p>babel 的转译过程分为三个阶段：parsing、transforming、generating，以 ES6 代码转译为 ES5 代码为例，babel 转译的具体过程如下：</p> <ol><li>ES6 代码输入</li> <li>babylon 进行解析得到 AST</li> <li>plugin 用 babel-traverse 对 AST 树进行遍历转译,得到新的 AST 树</li> <li>用 babel-generator 通过 AST 树生成 ES5 代码</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/react.html" class="prev">
          React
        </a></span> <span class="next"><a href="/ts.html">
          TypeScript
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.94b2f3ef.js" defer></script><script src="/assets/js/2.d467c8ee.js" defer></script><script src="/assets/js/10.7358a0a7.js" defer></script>
  </body>
</html>
